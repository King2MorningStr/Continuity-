name: Build UDAC Portal Android APK (Kivy)

on:
  workflow_dispatch:
  push:
    branches:
      - Gpt-Seph
      - claude/fix-crashes-production-ready-sohGx
      - claude/kivy-buildozer-fixes-AlTfo
      - main
      - master

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # Checkout repository
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # Verify project structure
      # -----------------------------
      - name: Verify project structure
        run: |
          set -e

          if [ ! -f "buildozer.spec" ]; then
            echo "ERROR: buildozer.spec not found in repo root"
            exit 1
          fi

          if [ ! -f "main.py" ]; then
            echo "ERROR: main.py not found in repo root"
            exit 1
          fi

          if [ ! -d "udac_portal" ]; then
            echo "ERROR: udac_portal directory not found"
            exit 1
          fi

          echo "‚úÖ Project structure verified (Kivy/Buildozer)"

      # -----------------------------
      # Python setup
      # -----------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # -----------------------------
      # Java setup (required for Android)
      # -----------------------------
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      # -----------------------------
      # System dependencies (Buildozer requirements)
      # -----------------------------
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git \
            zip \
            unzip \
            openjdk-17-jdk \
            python3-pip \
            autoconf \
            libtool \
            pkg-config \
            zlib1g-dev \
            libncurses5-dev \
            libncursesw5-dev \
            cmake \
            libffi-dev \
            libssl-dev \
            build-essential \
            ccache \
            libltdl-dev \
            python3-dev

          # Try to install libtinfo5 packages (may not be available on Ubuntu 22.04+)
          sudo apt-get install -y libtinfo5 libtinfo5-dev || echo "libtinfo5 packages not available, continuing without them"

      # -----------------------------
      # Install Buildozer and Cython
      # -----------------------------
      - name: Install Buildozer
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade buildozer cython

      # -----------------------------
      # Accept Android SDK licenses
      # -----------------------------
      - name: Accept Android licenses
        run: |
          yes | buildozer android debug || true

      # -----------------------------
      # Show build info
      # -----------------------------
      - name: Show build info
        run: |
          echo "üì¶ Building UDAC Portal v1.0.2 (Kivy)"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo ""
          echo "Buildozer version:"
          buildozer --version
          echo ""
          echo "Config:"
          cat buildozer.spec | grep -E "^(title|package|version|requirements)" | head -10

      # -----------------------------
      # Build APK with Buildozer
      # -----------------------------
      - name: Build APK
        run: |
          buildozer android debug

      # -----------------------------
      # Find and display APK info
      # -----------------------------
      - name: APK info
        run: |
          APK_PATH=$(find bin -name "*.apk" -type f | head -1)
          if [ -f "$APK_PATH" ]; then
            echo "‚úÖ Build successful!"
            echo "APK: $APK_PATH"
            ls -lh "$APK_PATH"
          else
            echo "‚ùå APK not found!"
            exit 1
          fi

      # -----------------------------
      # Upload APK artifact
      # -----------------------------
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
         name: udac-portal-kivy-apk
         path: bin/*.apk
